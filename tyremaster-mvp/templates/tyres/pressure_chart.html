<!-- templates/tyres/pressure_chart.html -->
{% extends 'base.html' %}

{% block title %}{{ vehicle.brand }} {{ vehicle.model }} Tyre Pressure Guide - TyreMaster{% endblock %}

{% block meta_description %}Complete tyre pressure guide for {{ vehicle.brand }} {{ vehicle.model }}. Cold vs hot pressures, loaded vs unloaded, front and rear tyre PSI recommendations.{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
            <li class="breadcrumb-item"><a href="{% url 'vehicle_detail' vehicle.slug %}">{{ vehicle.brand }} {{ vehicle.model }}</a></li>
            <li class="breadcrumb-item active" aria-current="page">Pressure Guide</li>
        </ol>
    </nav>
    
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h1>
                <i class="fas fa-chart-line text-primary"></i> 
                Tyre Pressure Guide
            </h1>
            <h3 class="text-muted">{{ vehicle.brand }} {{ vehicle.model }} ({{ vehicle.year }})</h3>
            
            <div class="d-flex align-items-center mt-3">
                <span class="badge bg-{% if vehicle.category == 'CAR' %}primary{% elif vehicle.category == 'BIKE' %}success{% else %}warning{% endif %} me-2">
                    {{ vehicle.get_category_display }}
                </span>
                <span><i class="fas fa-tire me-1"></i> 
                    {% if vehicle.tyres.tyre_size %}
                        Tyre Size: {{ vehicle.tyres.tyre_size }}
                    {% else %}
                        Front: {{ vehicle.tyres.get_front_display }}, Rear: {{ vehicle.tyres.get_rear_display }}
                    {% endif %}
                </span>
            </div>
        </div>
        <div class="col-md-4 text-end">
            <div class="card border-primary">
                <div class="card-body text-center">
                    <h5 class="card-title text-primary">Recommended Pressures</h5>
                    <div class="row mt-3">
                        <div class="col-6">
                            <p class="mb-1"><strong>Front</strong></p>
                            <h3 class="text-primary">{{ vehicle.tyres.front_pressure|default:"N/A" }}</h3>
                        </div>
                        <div class="col-6">
                            <p class="mb-1"><strong>Rear</strong></p>
                            <h3 class="text-danger">{{ vehicle.tyres.rear_pressure|default:"N/A" }}</h3>
                        </div>
                    </div>
                    <small class="text-muted">Standard conditions</small>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Chart Section -->
    <div class="row">
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar"></i> Tyre Pressure Comparison Chart
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Chart Container -->
                    <div class="chart-container" style="position: relative; height: 400px;">
                        <canvas id="pressureChart"></canvas>
                    </div>
                    
                    <!-- Chart Legend -->
                    <div class="row mt-4 text-center">
                        <div class="col-md-3">
                            <span class="badge bg-primary p-2">
                                <i class="fas fa-snowflake"></i> Cold Pressure
                            </span>
                        </div>
                        <div class="col-md-3">
                            <span class="badge bg-warning p-2">
                                <i class="fas fa-fire"></i> Hot Pressure
                            </span>
                        </div>
                        <div class="col-md-3">
                            <span class="badge bg-success p-2">
                                <i class="fas fa-weight"></i> Loaded Pressure
                            </span>
                        </div>
                        <div class="col-md-3">
                            <span class="badge bg-danger p-2">
                                <i class="fas fa-exclamation-triangle"></i> Maximum Pressure
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Detailed Pressure Table -->
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-table"></i> Detailed Pressure Specifications
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Condition</th>
                                    <th>Front Tyre (PSI)</th>
                                    <th>Rear Tyre (PSI)</th>
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>Cold (Morning)</strong></td>
                                    <td><span class="badge bg-primary">29 PSI</span></td>
                                    <td><span class="badge bg-primary">33 PSI</span></td>
                                    <td>Check before driving, when tyres are at ambient temperature</td>
                                </tr>
                                <tr>
                                    <td><strong>Hot (After driving)</strong></td>
                                    <td><span class="badge bg-warning">32 PSI</span></td>
                                    <td><span class="badge bg-warning">36 PSI</span></td>
                                    <td>Do NOT release air when tyres are hot</td>
                                </tr>
                                <tr>
                                    <td><strong>Light Load (1-2 persons)</strong></td>
                                    <td><span class="badge bg-success">28 PSI</span></td>
                                    <td><span class="badge bg-success">32 PSI</span></td>
                                    <td>For regular commuting without heavy luggage</td>
                                </tr>
                                <tr>
                                    <td><strong>Full Load (with luggage)</strong></td>
                                    <td><span class="badge bg-success">31 PSI</span></td>
                                    <td><span class="badge bg-success">35 PSI</span></td>
                                    <td>When carrying passengers or heavy items</td>
                                </tr>
                                <tr>
                                    <td><strong>Highway Driving</strong></td>
                                    <td><span class="badge bg-info">30 PSI</span></td>
                                    <td><span class="badge bg-info">34 PSI</span></td>
                                    <td>For long highway trips at sustained speeds</td>
                                </tr>
                                <tr>
                                    <td><strong>Maximum Safe Pressure</strong></td>
                                    <td><span class="badge bg-danger">36 PSI</span></td>
                                    <td><span class="badge bg-danger">40 PSI</span></td>
                                    <td>Do NOT exceed this pressure</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Pressure Calculator -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-calculator"></i> Pressure Calculator
                    </h5>
                </div>
                <div class="card-body">
                    <form id="pressureCalculator">
                        <div class="mb-3">
                            <label class="form-label">Current Pressure (PSI)</label>
                            <input type="number" class="form-control" id="currentPressure" 
                                   value="{% if vehicle.tyres.front_pressure %}{{ vehicle.tyres.front_pressure|slice:":2" }}{% else %}29{% endif %}" 
                                   min="20" max="50" step="1">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Temperature Change (°C)</label>
                            <select class="form-select" id="tempChange">
                                <option value="0">No change (25°C)</option>
                                <option value="10">Warmer (+10°C)</option>
                                <option value="-10">Cooler (-10°C)</option>
                                <option value="20">Hot day (+20°C)</option>
                                <option value="-20">Cold day (-20°C)</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Altitude Change</label>
                            <select class="form-select" id="altitudeChange">
                                <option value="0">Sea level</option>
                                <option value="1000">+1000m (mountains)</option>
                                <option value="-1000">-1000m (below sea level)</option>
                            </select>
                        </div>
                        
                        <div class="d-grid">
                            <button type="button" class="btn btn-success" onclick="calculatePressure()">
                                <i class="fas fa-calculator"></i> Calculate Adjusted Pressure
                            </button>
                        </div>
                        
                        <!-- Result -->
                        <div class="mt-3" id="pressureResult" style="display: none;">
                            <div class="alert alert-info">
                                <h6>Adjusted Pressure:</h6>
                                <h4 id="adjustedPressure" class="text-center">-- PSI</h4>
                                <small class="text-muted">This is an estimate. Always check with a gauge.</small>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Pressure Tips -->
            <div class="card mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="fas fa-lightbulb"></i> Pressure Tips
                    </h5>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        <div class="list-group-item">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            Check pressure when tyres are <strong>cold</strong>
                        </div>
                        <div class="list-group-item">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            Check at least <strong>once a month</strong>
                        </div>
                        <div class="list-group-item">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            Don't forget the <strong>spare tyre</strong>
                        </div>
                        <div class="list-group-item">
                            <i class="fas fa-exclamation-triangle text-danger me-2"></i>
                            Underinflation causes <strong>poor fuel economy</strong>
                        </div>
                        <div class="list-group-item">
                            <i class="fas fa-exclamation-triangle text-danger me-2"></i>
                            Overinflation causes <strong>uneven wear</strong>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Seasonal Pressure Guide -->
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-cloud-sun"></i> Seasonal Adjustments
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6">
                            <div class="card border-info mb-3">
                                <div class="card-body text-center">
                                    <i class="fas fa-sun fa-2x text-warning mb-2"></i>
                                    <h6>Summer</h6>
                                    <p class="mb-0 small">Reduce by 2-3 PSI</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="card border-info mb-3">
                                <div class="card-body text-center">
                                    <i class="fas fa-snowflake fa-2x text-primary mb-2"></i>
                                    <h6>Winter</h6>
                                    <p class="mb-0 small">Increase by 2-3 PSI</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="alert alert-secondary mt-2">
                        <small>
                            <i class="fas fa-info-circle"></i>
                            Air expands in heat, contracts in cold. Adjust accordingly.
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Important Safety Information -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card border-danger">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-exclamation-triangle"></i> Important Safety Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <h6><i class="fas fa-skull-crossbones text-danger"></i> Never Exceed</h6>
                            <p>Do not inflate beyond the maximum pressure marked on the tyre sidewall.</p>
                        </div>
                        <div class="col-md-4">
                            <h6><i class="fas fa-thermometer-half text-warning"></i> Check When Cold</h6>
                            <p>Tyres heat up while driving. Check pressure in the morning before driving.</p>
                        </div>
                        <div class="col-md-4">
                            <h6><i class="fas fa-balance-scale text-primary"></i> Regular Checks</h6>
                            <p>Check all tyres including spare at least once a month and before long trips.</p>
                        </div>
                    </div>
                    <hr>
                    <div class="alert alert-warning">
                        <strong>Disclaimer:</strong> These pressure recommendations are for guidance only. 
                        Always refer to your vehicle's owner manual or the placard on the driver's door jamb 
                        for manufacturer-recommended pressures. Conditions may vary.
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Download/Print Section -->
    <div class="card mt-4">
        <div class="card-body text-center">
            <h5 class="mb-3">
                <i class="fas fa-download"></i> Download This Guide
            </h5>
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-primary" onclick="printChart()">
                    <i class="fas fa-print"></i> Print Guide
                </button>
                <button type="button" class="btn btn-outline-success" onclick="saveAsPDF()">
                    <i class="fas fa-file-pdf"></i> Save as PDF
                </button>
                <button type="button" class="btn btn-outline-info" onclick="shareGuide()">
                    <i class="fas fa-share-alt"></i> Share
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Initialize chart when page loads
document.addEventListener('DOMContentLoaded', function() {
    renderPressureChart();
    initializeCalculator();
});

function renderPressureChart() {
    const ctx = document.getElementById('pressureChart').getContext('2d');
    
    // Sample data - in real app, this would come from the database
    const pressureData = {
        labels: ['Cold', 'Hot', 'Loaded', 'Maximum'],
        datasets: [
            {
                label: 'Front Tyre Pressure',
                data: [29, 32, 31, 36],
                backgroundColor: 'rgba(54, 162, 235, 0.5)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 2,
                tension: 0.1
            },
            {
                label: 'Rear Tyre Pressure',
                data: [33, 36, 35, 40],
                backgroundColor: 'rgba(255, 99, 132, 0.5)',
                borderColor: 'rgba(255, 99, 132, 1)',
                borderWidth: 2,
                tension: 0.1
            }
        ]
    };
    
    const pressureChart = new Chart(ctx, {
        type: 'line',
        data: pressureData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Tyre Pressure Variations (PSI)',
                    font: {
                        size: 16
                    }
                },
                legend: {
                    position: 'top',
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.dataset.label}: ${context.parsed.y} PSI`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: false,
                    min: 25,
                    max: 45,
                    title: {
                        display: true,
                        text: 'Pressure (PSI)'
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    }
                },
                x: {
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    }
                }
            }
        }
    });
}

function initializeCalculator() {
    // Set default values based on vehicle
    const frontPressure = {% if vehicle.tyres.front_pressure %}{{ vehicle.tyres.front_pressure|slice:":2" }}{% else %}29{% endif %};
    document.getElementById('currentPressure').value = frontPressure;
}

function calculatePressure() {
    const currentPressure = parseFloat(document.getElementById('currentPressure').value);
    const tempChange = parseFloat(document.getElementById('tempChange').value);
    const altitudeChange = parseFloat(document.getElementById('altitudeChange').value);
    
    if (isNaN(currentPressure) || currentPressure < 20 || currentPressure > 50) {
        alert('Please enter a valid pressure between 20 and 50 PSI');
        return;
    }
    
    // Calculate adjusted pressure
    // Formula: For every 10°C change, pressure changes by about 1 PSI
    const tempAdjustment = (tempChange / 10) * 1;
    const altitudeAdjustment = (altitudeChange / 1000) * 0.5;
    const adjustedPressure = currentPressure + tempAdjustment + altitudeAdjustment;
    
    // Display result
    const resultElement = document.getElementById('adjustedPressure');
    resultElement.textContent = adjustedPressure.toFixed(1) + ' PSI';
    
    const resultDiv = document.getElementById('pressureResult');
    resultDiv.style.display = 'block';
    
    // Color code based on safety
    if (adjustedPressure < 25 || adjustedPressure > 40) {
        resultElement.className = 'text-center text-danger';
    } else if (adjustedPressure < 28 || adjustedPressure > 36) {
        resultElement.className = 'text-center text-warning';
    } else {
        resultElement.className = 'text-center text-success';
    }
}

function printChart() {
    // Create print-friendly version
    const printContent = `
        <html>
            <head>
                <title>Tyre Pressure Guide - {{ vehicle.brand }} {{ vehicle.model }}</title>
                <style>
                    body { font-family: Arial, sans-serif; }
                    .header { text-align: center; margin-bottom: 20px; }
                    .chart-container { margin: 20px 0; }
                    table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                    th { background-color: #f2f2f2; }
                    .footer { margin-top: 30px; font-size: 12px; color: #666; }
                </style>
            </head>
            <body>
                <div class="header">
                    <h1>Tyre Pressure Guide</h1>
                    <h3>{{ vehicle.brand }} {{ vehicle.model }} ({{ vehicle.year }})</h3>
                    <p>Generated on ${new Date().toLocaleDateString()}</p>
                </div>
                
                <h4>Recommended Pressures:</h4>
                <p><strong>Front:</strong> {{ vehicle.tyres.front_pressure|default:"N/A" }}</p>
                <p><strong>Rear:</strong> {{ vehicle.tyres.rear_pressure|default:"N/A" }}</p>
                
                <h4>Pressure Specifications:</h4>
                <table>
                    <tr>
                        <th>Condition</th>
                        <th>Front Tyre (PSI)</th>
                        <th>Rear Tyre (PSI)</th>
                        <th>Notes</th>
                    </tr>
                    <tr>
                        <td>Cold (Morning)</td>
                        <td>29 PSI</td>
                        <td>33 PSI</td>
                        <td>Check before driving</td>
                    </tr>
                    <tr>
                        <td>Hot (After driving)</td>
                        <td>32 PSI</td>
                        <td>36 PSI</td>
                        <td>Do NOT release air when hot</td>
                    </tr>
                    <tr>
                        <td>Light Load</td>
                        <td>28 PSI</td>
                        <td>32 PSI</td>
                        <td>1-2 persons</td>
                    </tr>
                    <tr>
                        <td>Full Load</td>
                        <td>31 PSI</td>
                        <td>35 PSI</td>
                        <td>With luggage/passengers</td>
                    </tr>
                </table>
                
                <div class="footer">
                    <p><strong>Important:</strong> Always refer to your vehicle's owner manual for exact specifications.</p>
                    <p>Generated by TyreMaster - https://tyremaster.com</p>
                </div>
            </body>
        </html>
    `;
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(printContent);
    printWindow.document.close();
    printWindow.print();
}

function saveAsPDF() {
    alert('PDF generation would be implemented with a backend library like ReportLab or WeasyPrint.');
    // In production, you would:
    // 1. Make an AJAX call to a Django view that generates PDF
    // 2. Return the PDF as a downloadable file
}

function shareGuide() {
    const url = window.location.href;
    const title = 'Tyre Pressure Guide for {{ vehicle.brand }} {{ vehicle.model }}';
    const text = 'Check out this tyre pressure guide on TyreMaster!';
    
    if (navigator.share) {
        navigator.share({
            title: title,
            text: text,
            url: url,
        })
        .then(() => console.log('Shared successfully'))
        .catch((error) => console.log('Error sharing:', error));
    } else {
        // Fallback: Copy to clipboard
        navigator.clipboard.writeText(url).then(() => {
            alert('Link copied to clipboard! Share it with others.');
        });
    }
}
</script>

<style>
.chart-container {
    position: relative;
    height: 400px;
    width: 100%;
}

.card {
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    transition: transform 0.3s;
}

.card:hover {
    transform: translateY(-5px);
}

.list-group-item {
    border: none;
    padding: 12px 15px;
}

.badge {
    font-size: 0.9em;
    padding: 8px 12px;
}

.table th {
    background-color: #f8f9fa;
    font-weight: 600;
}
</style>
{% endblock %}