{% extends 'base.html' %}

{% block title %}Tyre Size Calculator - TyreMaster{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">
        <i class="fas fa-calculator text-primary"></i> Tyre Size Calculator
    </h1>
    
    <div class="row">
        <!-- Calculator Form -->
        <div class="col-lg-6">
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Calculate Tyre Dimensions</h5>
                </div>
                <div class="card-body">
                    <form id="tyreCalculatorForm">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Width (mm)</label>
                                <input type="number" class="form-control" id="width" 
                                       placeholder="e.g., 195" min="100" max="400" value="195">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Aspect Ratio (%)</label>
                                <input type="number" class="form-control" id="aspect_ratio" 
                                       placeholder="e.g., 65" min="30" max="100" value="65">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Rim Diameter (inches)</label>
                                <input type="number" class="form-control" id="rim_diameter" 
                                       placeholder="e.g., 15" min="10" max="24" value="15">
                            </div>
                        </div>
                        
                        <div class="d-grid">
                            <button type="button" class="btn btn-primary" onclick="calculateTyre()">
                                <i class="fas fa-calculator"></i> Calculate
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Quick Examples -->
            <div class="card">
                <div class="card-body">
                    <h6><i class="fas fa-bolt"></i> Quick Examples</h6>
                    <div class="d-flex flex-wrap gap-2 mt-2">
                        <button class="btn btn-sm btn-outline-secondary" 
                                onclick="setExample(195, 65, 15)">195/65R15</button>
                        <button class="btn btn-sm btn-outline-secondary"
                                onclick="setExample(205, 55, 16)">205/55R16</button>
                        <button class="btn btn-sm btn-outline-secondary"
                                onclick="setExample(225, 45, 17)">225/45R17</button>
                        <button class="btn btn-sm btn-outline-secondary"
                                onclick="setExample(90, 90, 12)">90/90-12</button>
                        <button class="btn btn-sm btn-outline-secondary"
                                onclick="setExample(100, 80, 17)">100/80-17</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Results -->
        <div class="col-lg-6">
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">Calculation Results</h5>
                </div>
                <div class="card-body">
                    <div id="results" class="text-center">
                        <p class="text-muted">Enter tyre size and click Calculate</p>
                    </div>
                </div>
            </div>
            
            <!-- Alternative Sizes -->
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">Alternative Sizes</h5>
                </div>
                <div class="card-body">
                    <div id="alternatives">
                        <p class="text-muted">Alternative sizes will appear here</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Explanation Section -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h5><i class="fas fa-info-circle"></i> Understanding Tyre Size Calculations</h5>
                    
                    <div class="row mt-3">
                        <div class="col-md-4">
                            <h6>Tyre Dimensions</h6>
                            <p><strong>Diameter:</strong> Overall tyre diameter</p>
                            <p><strong>Circumference:</strong> Distance around the tyre</p>
                            <p><strong>Sidewall:</strong> Height of tyre sidewall</p>
                        </div>
                        <div class="col-md-4">
                            <h6>Speedometer Impact</h6>
                            <p>Changing tyre size affects your speedometer reading:</p>
                            <ul class="small">
                                <li>Larger tyre = Speedometer reads slower</li>
                                <li>Smaller tyre = Speedometer reads faster</li>
                            </ul>
                        </div>
                        <div class="col-md-4">
                            <h6>Safe Alternatives</h6>
                            <p>Alternative sizes should have:</p>
                            <ul class="small">
                                <li>Â±3% overall diameter difference</li>
                                <li>Same rim diameter</li>
                                <li>Proper load capacity</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function setExample(width, ratio, rim) {
    document.getElementById('width').value = width;
    document.getElementById('aspect_ratio').value = ratio;
    document.getElementById('rim_diameter').value = rim;
}

function calculateTyre() {
    const width = document.getElementById('width').value;
    const aspectRatio = document.getElementById('aspect_ratio').value;
    const rimDiameter = document.getElementById('rim_diameter').value;
    
    if (!width || !aspectRatio || !rimDiameter) {
        alert('Please fill all fields');
        return;
    }
    
    // Show loading
    document.getElementById('results').innerHTML = `
        <div class="text-center py-3">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Calculating...</p>
        </div>
    `;
    
    // Make AJAX request
    const formData = new FormData();
    formData.append('width', width);
    formData.append('aspect_ratio', aspectRatio);
    formData.append('rim_diameter', rimDiameter);
    
    fetch('/calculate-tyre-size/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            document.getElementById('results').innerHTML = `
                <div class="alert alert-danger">
                    Error: ${data.error}
                </div>
            `;
            return;
        }
        
        // Display results
        document.getElementById('results').innerHTML = `
            <h3 class="text-primary">${data.metric_size}</h3>
            <p class="text-muted">Imperial: ${data.imperial_size}</p>
            
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="card border-0 bg-light">
                        <div class="card-body">
                            <h6>Dimensions</h6>
                            <p class="mb-1">Diameter: ${data.diameter_mm} mm (${data.diameter_inches}")</p>
                            <p class="mb-1">Circumference: ${data.circumference_mm} mm</p>
                            <p class="mb-0">Sidewall: ${data.sidewall_height} mm</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card border-0 bg-light">
                        <div class="card-body">
                            <h6>Performance</h6>
                            <p class="mb-1">Revs per km: ${data.revolutions_per_km}</p>
                            <p class="mb-1">Revs per mile: ${data.revolutions_per_mile}</p>
                            <p class="mb-0">Sidewall ratio: ${aspectRatio}%</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Display alternatives
        if (data.alternative_sizes && data.alternative_sizes.length > 0) {
            let altHtml = '<div class="row">';
            data.alternative_sizes.forEach(alt => {
                altHtml += `
                    <div class="col-md-6 mb-2">
                        <div class="card border ${alt.diameter_diff > 0 ? 'border-warning' : 'border-info'}">
                            <div class="card-body p-2">
                                <strong>${alt.size}</strong><br>
                                <small>Speedo: ${alt.speedo_error}</small>
                            </div>
                        </div>
                    </div>
                `;
            });
            altHtml += '</div>';
            document.getElementById('alternatives').innerHTML = altHtml;
        }
    })
    .catch(error => {
        document.getElementById('results').innerHTML = `
            <div class="alert alert-danger">
                Error calculating tyre size. Please try again.
            </div>
        `;
    });
}

// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Calculate on page load with default values
document.addEventListener('DOMContentLoaded', function() {
    calculateTyre();
});
</script>
{% endblock %}